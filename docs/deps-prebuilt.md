# Prebuilt Dependencies

This document describes the prebuilt binary artifacts for ubiblk's dependencies and how to use them in CI/CD environments.

## Overview

The ubiblk project depends on two external libraries:
- **isa-l_crypto** - Intel's ISA-L Crypto library for optimized cryptographic operations
- **libblkio** - High-performance block I/O library with various backend support

To simplify CI/CD and ensure consistent builds, we provide prebuilt binary artifacts for both libraries.

## Build Configuration

### Ubuntu Compatibility

All artifacts are built inside **Ubuntu 22.04** containers to ensure maximum forward compatibility:
- Binaries built on Ubuntu 22.04 will work on both Ubuntu 22.04 and 24.04
- This is achieved through glibc compatibility - older glibc binaries work with newer glibc versions
- Building in containers ensures consistent dependency versions

### CPU Architecture Baseline

To ensure the binaries work on a wide range of systems without requiring special CPU features, we use conservative baseline compiler flags:

#### x86_64 (x86-64-v1 / Generic)
- **CFLAGS**: `-O2 -pipe -fPIC -march=x86-64 -mtune=generic`
- **Baseline**: x86-64-v1 (original x86-64 specification)
- No AVX, AVX2, or other optional extensions required
- Works on any x86_64 CPU from the past 20+ years

#### ARM64 (ARMv8-A Baseline)
- **CFLAGS**: `-O2 -pipe -fPIC -march=armv8-a`
- **Baseline**: ARMv8-A base architecture
- No optional extensions required
- Works on any ARMv8 or newer ARM64 CPU

### Available Architectures

Prebuilt artifacts are available for:
- **x86_64** (AMD64)
- **arm64** (AArch64)

## Artifact Naming Convention

Artifacts follow this naming pattern:

```
{project}-{git_ref}-ubuntu22.04-baseline-{arch}.tar.zst
```

Examples:
- `isa-l_crypto-v2.25.0-ubuntu22.04-baseline-x86_64.tar.zst`
- `libblkio-main-ubuntu22.04-baseline-arm64.tar.zst`

## Artifact Contents

Each `.tar.zst` archive contains:

```
├── include/          # Header files
├── lib/              # Libraries (static and/or shared)
├── BUILDINFO.txt     # Build metadata and compiler flags
└── LICENSES/         # Full license texts for the project
    └── {project}-LICENSE.txt
```

### BUILDINFO.txt

Each artifact includes a `BUILDINFO.txt` file with complete build metadata:
- Upstream repository URL
- Git reference (tag/branch) and resolved commit SHA
- Build OS and container image
- Compiler versions (GCC and Clang)
- Complete CFLAGS, CXXFLAGS, and LDFLAGS used
- Configure/build system arguments

Example:
```
Project: isa-l_crypto
Repository: https://github.com/intel/isa-l_crypto
Git Ref: v2.25.0
Commit SHA: 9b7a2b842c9f4e54b8dc1c82899e5a5520c53301
Build OS: ubuntu:22.04 (container)
Architecture: x86_64
Build Date: 2024-01-11T10:30:00Z
Compiler (GCC): gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0
CFLAGS: -O2 -pipe -fPIC -march=x86-64 -mtune=generic
...
```

## Downloading Artifacts

### From GitHub Actions

Artifacts are generated by the `prebuild-deps` workflow and can be downloaded from:
1. Workflow run artifacts (30-day retention)
2. GitHub Releases (if published)

### Manual Trigger

To build new artifacts:
1. Go to Actions → Prebuild Dependencies
2. Click "Run workflow"
3. Select options:
   - `ubuntu_base`: Ubuntu version (defaults to 22.04)
   - `isal_ref`: isa-l_crypto git ref (tag/branch/commit)
   - `blkio_ref`: libblkio git ref (tag/branch/commit)
4. Download artifacts from the workflow run

## Verifying Artifacts

Each build produces:
- Individual architecture artifacts (`.tar.zst` files)
- `SHA256SUMS-{arch}.txt` for each architecture
- Combined `SHA256SUMS` with all checksums
- `manifest.json` with metadata and checksums

### Verification Steps

1. **Verify SHA256 checksums**:
```bash
# Download SHA256SUMS file
sha256sum -c SHA256SUMS
```

2. **Inspect build metadata**:
```bash
# Extract BUILDINFO without extracting full archive
tar -I zstd -xf isa-l_crypto-v2.25.0-ubuntu22.04-baseline-x86_64.tar.zst BUILDINFO.txt -O
```

3. **Verify licenses**:
```bash
# Extract licenses
tar -I zstd -xf isa-l_crypto-v2.25.0-ubuntu22.04-baseline-x86_64.tar.zst LICENSES/
cat LICENSES/isa-l_crypto-LICENSE.txt
```

## Using in CI

### Example: GitHub Actions

```yaml
steps:
  - name: Download prebuilt dependencies
    run: |
      # Download artifacts (example using wget or from GitHub Release)
      wget https://github.com/ubicloud/ubiblk/releases/download/deps-v1/isa-l_crypto-v2.25.0-ubuntu22.04-baseline-x86_64.tar.zst
      wget https://github.com/ubicloud/ubiblk/releases/download/deps-v1/SHA256SUMS
      
      # Verify checksums
      sha256sum -c SHA256SUMS
  
  - name: Extract dependencies
    run: |
      # Extract to /usr/local
      sudo tar -I zstd -xf isa-l_crypto-v2.25.0-ubuntu22.04-baseline-x86_64.tar.zst -C /usr/local
      
      # Or extract to custom prefix
      mkdir -p $HOME/deps/isal
      tar -I zstd -xf isa-l_crypto-v2.25.0-ubuntu22.04-baseline-x86_64.tar.zst -C $HOME/deps/isal
  
  - name: Build project with dependencies
    run: |
      # If installed to /usr/local, should work automatically
      cargo build
      
      # If using custom prefix, set environment variables
      export PKG_CONFIG_PATH=$HOME/deps/isal/lib/pkgconfig:$PKG_CONFIG_PATH
      export LD_LIBRARY_PATH=$HOME/deps/isal/lib:$LD_LIBRARY_PATH
      cargo build
```

### Example: Docker Build

```dockerfile
FROM ubuntu:22.04

# Install zstd for extraction
RUN apt-get update && apt-get install -y zstd

# Copy prebuilt artifacts
COPY isa-l_crypto-v2.25.0-ubuntu22.04-baseline-x86_64.tar.zst /tmp/

# Extract to /usr/local
RUN tar -I zstd -xf /tmp/isa-l_crypto-v2.25.0-ubuntu22.04-baseline-x86_64.tar.zst -C /usr/local && \
    rm /tmp/isa-l_crypto-v2.25.0-ubuntu22.04-baseline-x86_64.tar.zst

# Build your project
COPY . /app
WORKDIR /app
RUN cargo build --release
```

## Building from Source

If you prefer to build the dependencies yourself, refer to the workflow file at `.github/workflows/prebuild-deps.yml` for the exact build commands and flags used.

The key steps are:
1. Use Ubuntu 22.04 environment
2. Apply conservative compiler flags
3. Build and install to a prefix directory
4. Package with licenses and metadata

## Troubleshooting

### Symbol not found / Undefined reference

If you get linking errors, ensure:
1. You're extracting the correct architecture (x86_64 vs arm64)
2. Libraries are in your library search path (`LD_LIBRARY_PATH` or `/usr/local/lib`)
3. pkg-config can find the libraries (`PKG_CONFIG_PATH`)

### Incompatible glibc version

If you see glibc version errors:
1. Verify you're on Ubuntu 22.04 or newer (or equivalent glibc 2.35+)
2. Check that you downloaded the correct artifact (ubuntu22.04-baseline)
3. Ensure you're not mixing artifacts from different builds

### CPU feature not supported

This should not happen with baseline builds. If you see CPU feature errors:
1. Verify you downloaded the `-baseline-` artifacts (not a custom build)
2. Check the BUILDINFO.txt to confirm compiler flags
3. Report an issue if the baseline flags are incorrect

## License Information

Both dependencies have permissive open-source licenses:

- **isa-l_crypto**: BSD-3-Clause
- **libblkio**: LGPL-2.1-or-later with some Apache-2.0 components

Full license texts are included in each artifact under the `LICENSES/` directory.

See also: [THIRD_PARTY_NOTICES.md](../THIRD_PARTY_NOTICES.md) in the repository root.
